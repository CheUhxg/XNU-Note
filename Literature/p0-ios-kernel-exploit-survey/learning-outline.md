# 学习大纲：从 Survey 出发系统学习 iOS Kernel Exploit（iOS 10–13）

本大纲以 Project Zero 的 survey 为主线，目标是让你能：

1) 看懂 exploit 的“高层流程图”（从漏洞到 kernel r/w）
2) 掌握复用度高的核心积木（Mach port / OOL / IOSurface / pipe / heap grooming）
3) 理解 mitigations 如何迫使 exploit 形态演化（PAN/PAC/zone_require 等）

> 主参考：
> https://projectzero.google/2020/06/a-survey-of-recent-ios-kernel-exploits.html

---

## Phase 0：预备知识（1–2 天）

- 目标
  - 建立 XNU/Mach 的最小心智模型：task/port/message/rights
  - 能看懂“为什么 OOL ports 能给你一个 right / 为什么 fake port 很有用”
- 需要掌握
  - Mach message 基本结构（尤其 OOL memory / OOL ports 描述符）
  - IOKit user client 的调用方式（external method / trap 的概念即可）
  - XNU 内核堆大致概念：kalloc、zone、对象复用、GC/回收

输出物
- 画一张你自己的“Mach port 交互图”：进程有哪些 rights、消息如何携带描述符、内核对象生命周期何时结束。

---

## Phase 1：通读 Survey，做“模式标注”（1 天）

- 目标
  - 不追细节地通读 survey，每个条目只抓三件事：
    1) 漏洞类型/初始原语（UAF/OOB write/信息泄露/引用计数等）
    2) 关键载体（IOSurface/pipe/OOL ports/OSData/IOKit UC）
    3) 最终怎么拿到 kernel r/w（fake task port？copyin/copyout？任意调用？）

建议做一张表（可以自己开个 Markdown/表格）
- Exploit 名称 / iOS 版本
- 初始 primitive
- 主要 spray/groom 载体
- KASLR 怎么破
- 读原语怎么建
- 写原语怎么建
- 最终落点（fake kernel task port / tfp0 等）

输出物
- 1 张表 + 3 条你观察到的“共性套路”。

---

## Phase 2：挑 3 个代表性 exploit 做深读（3–7 天）

按“时代/缓解机制变化”挑样本会更有收益：

### 样本 A：iOS 10–11 早期（Mach/OOL/port 生态）

候选：`mach_portal`、`extra_recipe`、`async_wake`

学习重点
- dangling port / fake port 的生命周期与复用
- OOL ports 如何把指针/rights 从内核搬到用户态
- 如何利用 vtable/对象指针推导 KASLR slide

推荐延伸阅读（来自 survey 引用）
- Exception oriented exploitation on iOS（理解“用异常消息做读写/覆盖”的思路）
- async_wake exploit code（对照 survey 的 exploit flow）

### 样本 B：iOS 12（voucher/MIG、PAN/PAC 时代的约束）

候选：`voucher_swap`、`machswap2`、`Chaos`

学习重点
- MIG 引用计数语义如何变成 UAF/引用计数漏洞
- PAN 条件下如何把可控数据放进内核，并拿到内核地址
- PAC 背景下为什么 vtable 劫持这类 technique 受限

推荐延伸阅读
- voucher_swap: Exploiting MIG reference counting in iOS 12
- Examining pointer authentication on the iPhone XS（PAC 基础）

### 样本 C：iOS 13（zone_require 的冲击）

候选：`oob_timestamp`

学习重点
- zone_require 对 fake Mach port 的直接影响
- 为什么“对象必须来自预期 zone”会改变利用链形态

输出物
- 每个样本产出 1 张 exploit flow 图（用框图即可），以及“关键数据结构/关键系统调用”的清单。

---

## Phase 3：把 mitigations 和技术做映射（1–2 天）

- 目标
  - 看到一条 exploit flow 能快速回答：
    - 它是怎么绕过/工作于 KASLR、PAN、PAC、zone_require 等限制下的？
    - 这条链路的脆弱点是什么？（比如依赖某种可预测堆布局、依赖某类信息泄露、依赖某个检查遗漏）

建议输出
- 一张二维表：
  - 行：KASLR / heap ASLR / PAN / KTRR / APRR+PPL / PAC / zone_require
  - 列：常见 technique（spray、泄露、fake port、任意调用、copyin/out 等）
  - 单元格：该 mitigation 对 technique 的限制点与常见对策

---

## Phase 4：回到 XNU-Note：形成可复用笔记结构（持续）

建议你在仓库里长期保留三类笔记：

- 机制类：Mach ports & messages、IOSurface property、pipe buffer、XNU zones
- 技术类：heap grooming、dangling/fake port、任意读写构造范式
- 案例类：每个 exploit 一页，包含 flow 图 + 关键原语 + 关键 API

---

## 校验清单（你读懂了就算阶段完成）

- 你能解释“为什么 fake Mach port 能当成通用把手”，并举 2 个从 survey 来的例子
- 你能描述至少 2 种破 KASLR 的路径（vtable、信息泄露、扫描等）以及它们的前提
- 你能说明 PAN/PAC/zone_require 分别主要杀伤哪类 technique
- 你能把任意读写拆成：地址如何控、数据如何控、触发路径如何选、可靠性如何保证
