#!/usr/bin/env python3
"""
爬取 exploit/mitigation 参考链接并总结到 markdown 文件。
"""

from __future__ import annotations

import re
from pathlib import Path
from typing import Optional
import time

ROOT = Path(__file__).resolve().parent

# 关键链接及其类型
KEY_WRITEUPS = {
    "https://projectzero.google/2019/08/in-wild-ios-exploit-chain-1.html": "itw-chain-1",
    "https://projectzero.google/2019/08/in-wild-ios-exploit-chain-2.html": "itw-chain-2",
    "https://projectzero.google/2019/08/in-wild-ios-exploit-chain-3.html": "itw-chain-3",
    "https://projectzero.google/2019/08/in-wild-ios-exploit-chain-4.html": "itw-chain-4",
    "https://projectzero.google/2019/08/in-wild-ios-exploit-chain-5.html": "itw-chain-5",
    "https://projectzero.google/2019/01/voucherswap-exploiting-mig-reference.html": "voucher_swap",
    "https://projectzero.google/2019/12/sockpuppet-walkthrough-of-kernel.html": "sockpuppet",
    "https://projectzero.google/2017/04/exception-oriented-exploitation-on-ios.html": "extra_recipe",
    "https://siguza.github.io/v0rtex/": "v0rtex",
    "https://www.synacktiv.com/posts/exploit/lightspeed-a-race-for-an-iosmacos-sandbox-escape.html": "lightspeed",
    "https://sparkes.zone/blog/ios/2019/04/30/machswap-ios-12-kernel-exploit.html": "machswap2",
    "https://blog.zecops.com/vulnerabilities/releasing-first-public-task-for-pwn0-tfp0-granting-poc-on-ios/": "appleave2driver",
    "https://blogs.360.cn/post/IPC%20Voucher%20UaF%20Remote%20Jailbreak%20Stage%202%20(EN).html": "chaos",
    "https://www.blackhat.com/docs/eu-17/materials/eu-17-Donenfeld-Rooten-Apples-Vulnerability-Heaven-In-The-IOS-Sandbox.pdf": "ziva",
    "https://i.blackhat.com/USA-19/Thursday/us-19-Wang-Attacking-IPhone-XS-Max.pdf": "attacking-iphonexsmax",
}

GITHUB_EXPLOITS = {
    "https://github.com/doadam/ziVA": "ziVA exploit (GitHub repo)",
    "https://github.com/kpwn/yalu102": "Yalu102 exploit (GitHub repo)",
    "https://github.com/Siguza/v0rtex": "v0rtex exploit (GitHub repo)",
    "https://github.com/JakeBlair420/Spice": "Spice exploit (GitHub repo)",
    "https://github.com/tihmstar/treadm1ll": "treadm1ll exploit (GitHub repo)",
    "https://github.com/PsychoTea/machswap2": "machswap2 exploit (GitHub repo)",
    "https://github.com/potmdehex/multipath_kfree": "multipath_kfree exploit (GitHub repo)",
    "https://bugs.chromium.org/p/project-zero/issues/detail?id=965#c2": "mach_portal exploit code",
    "https://bugs.chromium.org/p/project-zero/issues/detail?id=1004#c4": "extra_recipe exploit code",
    "https://bugs.chromium.org/p/project-zero/issues/detail?id=1417#c17": "async_wake exploit code",
    "https://bugs.chromium.org/p/project-zero/issues/detail?id=1558#c3": "multi_path exploit code",
    "https://bugs.chromium.org/p/project-zero/issues/detail?id=1564#c10": "empty_list exploit code",
    "https://bugs.chromium.org/p/project-zero/issues/detail?id=1731#c10": "voucher_swap exploit code",
    "https://bugs.chromium.org/p/project-zero/issues/detail?id=1806#c13": "SockPuppet exploit code",
    "https://bugs.chromium.org/p/project-zero/issues/detail?id=1986#c5": "oob_timestamp exploit code",
}

def extract_refs_from_md(path: Path) -> dict[str, str]:
    """从 markdown 文件中提取参考链接。"""
    content = path.read_text(encoding="utf-8")
    refs = {}
    # 匹配 - [text](url) 格式
    pattern = r"- \[([^\]]+)\]\(([^)]+)\)"
    for match in re.finditer(pattern, content):
        text, url = match.groups()
        refs[url] = text
    return refs

def is_fetchable_url(url: str) -> bool:
    """判断 URL 是否可抓取（排除 GitHub repo 等）。"""
    if "github.com" in url:
        return False
    if "bugs.chromium.org" in url:
        return False
    return url.startswith("http")

def main() -> None:
    """主流程：扫描所有文件，提取 URL，汇总统计。"""
    all_refs: dict[str, list[Path]] = {}
    
    # 扫描所有 event 和 mitigation 文件
    for md_file in sorted((ROOT / "events").glob("*.md")) + sorted((ROOT / "mitigations").glob("*.md")):
        refs = extract_refs_from_md(md_file)
        for url, text in refs.items():
            if url not in all_refs:
                all_refs[url] = []
            all_refs[url].append(md_file)
    
    print(f"Total unique URLs found: {len(all_refs)}")
    print(f"\nFetchable URLs (projectzero, blogs, etc):")
    fetchable = {u: f for u, f in all_refs.items() if is_fetchable_url(u)}
    for url in sorted(fetchable.keys()):
        print(f"  {url}")
    
    print(f"\n总计：{len(fetchable)} 个可抓 URL，{len(all_refs) - len(fetchable)} 个代码仓库/issue")

if __name__ == "__main__":
    main()
