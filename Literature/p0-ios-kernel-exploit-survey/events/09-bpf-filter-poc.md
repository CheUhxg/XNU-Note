# Incomplete exploit for CVE-2018-4150 (bpf-filter-poc)

- 目标系统: iOS 11.2.6
- CVE: CVE-2018-4150

## 初始原语（primitive）
BPF race 导致线性堆溢出，覆盖 OOL ports array 并注入 userspace fake port 指针。

## 漏洞特定利用策略（strategy）
触发 race 增长长度但未重分配；发送 packet 溢出到 OOL ports array；接收得到 fake port right。

## 后续通用利用流程（subsequent exploit flow）
clock_sleep_trap brute force；pid_for_task 建读原语并扫描定位 kernel text base；后续构造 fake kernel task port（条目注记：实现不完整）。

## 关键可复用技术点（techniques）
- OOL ports 注入 fake port
- clock_sleep_trap brute force
- pid_for_task 读 + 扫描

## 与缓解机制的关系（notes）
- survey 注记：PAN 启用时不可用；链路不完整。

## 参考
- [POC](https://github.com/Jailbreaks/CVE-2018-4150/blob/master/CVE-2018-4150.c)
- [repo](https://github.com/littlelailo/incomplete-exploit-for-CVE-2018-4150-bpf-filter-poc-)

### 参考内容摘要

**原文概述**：CVE-2018-4150（iOS 11.2.6）是 BPF 过滤器实现中的 race：生成 BPF 代码时长度计算与实际分配存在竞争；两线程可导致 allocated buffer 增长但未重分配（size 字段更新但指针未改），超出范围溢出。Exploit：①分配 BPF 规则使其 buffer 位于 OOL ports array 前；②触发 race 使 size 增长；③发送 packet 溢出覆写 OOL ports array 条目为 userspace fake port 指针；④接收消息获得 fake port send right；⑤用 clock_sleep_trap 暴力破 KASLR；⑥用 pid_for_task 实现读原语并扫描内核；⑦尝试构造 fake kernel task port（链不完整）。A10+ 的 PAN 限制了 userspace fake port 的有效性。技术亮点：race-based 缓冲区溢出、OOL ports 直接注入 fake 指针、clock_sleep_trap 和 pid_for_task 的组合。该链属于 yalu102 系列思路但采用 BPF race 触发。
