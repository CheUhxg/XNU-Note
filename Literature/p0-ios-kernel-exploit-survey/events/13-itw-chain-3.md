# In-the-wild iOS Exploit Chain 3 (VXD393/D5500)

- 目标系统: iOS 11.4
- CVE: （survey 条目未给出或为多漏洞）

## 初始原语（primitive）
double-free：DestroyDecoder() 未清理指针导致重复释放。

## 漏洞特定利用策略（strategy）
OSData/IOSurface spray 多轮重占位；通过 OOL ports array + IOSurface 读回泄露目标 port 地址；销毁 holding port drop ref 两次得到已知地址 dangling port。

## 后续通用利用流程（subsequent exploit flow）
zone GC + segmented spray 定位；pipe buffers 重分配得到 fake port；clock_sleep_trap brute force；pid_for_task 读；构造 fake kernel task port。

## 关键可复用技术点（techniques）
- IOSurface 读回泄露
- segmented spray + pipe

## 与缓解机制的关系（notes）
- in-the-wild 复盘。

## 参考
- [writeup](https://projectzero.google/2019/08/in-wild-ios-exploit-chain-3.html)

### 参考内容摘要

**原文概述**：Chain 3 分析（针对 iOS 11.0-11.4.1），这是首条包含独立沙盒逃逸 exploit 的链。沙盒逃逸漏洞在 libxpc：refactoring 导致 < 边界检查被改为 != 比较，且被检查值直接来自 IPC 消息并用于数组索引获取函数指针——这属于 fuzzing 或 unit test 应能发现的严重回归（regression bug）。攻击者通过构造特殊 XPC 消息触发越界读并控制函数指针调用，结合 heapspray（对 mediaserverd 进程利用 MIG 消息处理缺陷泄漏大量 OOL memory 和端口 send rights）实现 RCE。内核 exploit 目标为 VXD393/D5500 视频解码器驱动的 repeated IOFree 漏洞：外部方法 DestroyDecoder 未清空 userclient 结构中指针，导致 double-free。利用策略与 Chain 2 相似但更为精巧：通过 IOSurface properties 喷射 OSData 对象占位（0x38/0x1000 size）；构造 target_port 被 before/after ports 包围；触发 double-free 后用 OSData 替换；通过 IOSurface 属性读回泄露 target_port 地址；反复替换并从相邻端口泄露；执行 zone GC 并使用 segmented OOL memory spray；最终用 pipe buffers 构建 fake port；同样使用 clock_sleep_trap 爆破 KASLR、pid_for_task 建立读原语、fake kernel task port、后利用阶段标记设备为"iop114"。该链展示出攻击者对边际成本（marginal cost）原则的深刻理解：一旦开发出一套利用框架，后续每条新链的开发成本显著降低，可复用多数组件且缓解措施只需在首次出现时绕过一次。
