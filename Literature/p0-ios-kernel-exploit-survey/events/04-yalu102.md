# Yalu102

- 目标系统: iOS 10.2
- CVE: CVE-2017-2370

## 初始原语（primitive）
溢出覆盖 OOL port array，在 userspace 插入 fake Mach port 指针；接收得到 fake port send right。

## 漏洞特定利用策略（strategy）
直接把 OOL ports array 条目改成指向 userspace 伪造 port。

## 后续通用利用流程（subsequent exploit flow）
fake port→clock port，用 clock_sleep_trap 暴力猜测内核指针；再转 fake task port 用 pid_for_task 建读原语；扫描定位 kernel text base 破 KASLR；构造 fake kernel task port。

## 关键可复用技术点（techniques）
- OOL ports 注入 fake port 指针
- clock_sleep_trap brute force
- pid_for_task 读原语 + 扫描

## 与缓解机制的关系（notes）
- survey 注记：PAN 启用时不可用。

## 参考
- [exploit code](https://github.com/kpwn/yalu102)

### 参考内容摘要

**原文概述**：yalu102（由 qwertyoruiopz、Luca Todesco 等开发）是第一个广泛可用的 iOS 10.2 越狱工具，基于 CVE-2017-2370（mach_voucher_extract_attr_recipe_trap 堆溢出，同 extra_recipe）与其他漏洞链组合。exploit 链特点：①利用溢出直接覆盖 OOL ports descriptor 数组的条目；②插入 userspace 伪造的 fake port 指针（无需内核分配）；③接收消息时内核返回该 fake port 的 send right；④将 fake port 设置为 IKOT_CLOCK 类型并用 clock_sleep_trap 暴力猜测 kernel base（256 次尝试遍历所有 KASLR 位置）；⑤转换为 IKOT_TASK 类型的 fake port 并用 pid_for_task 读 4 字节（可通过改写 context 更新读地址）；⑥扫描内核数据找到 kernel_task、vtable、函数指针等关键对象地址；⑦构造 fake kernel task port 获得 kernel r/w；⑧后利用脱沙箱。该 exploit 之所以影响广泛，是因为它相对稳定且无需复杂的堆布局（直接溢出覆盖、fake port 在用户空间而非堆上）。缺点是对 PAN（Privileged Access Never）无效，A10+ 启用 PAN 后无法从用户空间访问内核内存，因此 fake port 在内核检查时会触发异常。
