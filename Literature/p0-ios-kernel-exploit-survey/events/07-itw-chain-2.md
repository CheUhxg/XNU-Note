# In-the-wild iOS Exploit Chain 2 (IOSurface)

- 目标系统: iOS 10.3.3
- CVE: CVE-2017-13861

## 初始原语（primitive）
引用错误制造 dangling ports，并通过重分配与 segmented spray 精确定位落点。

## 漏洞特定利用策略（strategy）
用 mach_port_get_context 泄露另一 port 地址作为锚点；重复触发获得已知地址 dangling port。

## 后续通用利用流程（subsequent exploit flow）
segmented OOL memory spray 定位段；pipe buffers 重分配得到可控 fake port；clock_sleep_trap brute force 破 KASLR；pid_for_task 建读原语；构造 fake kernel task port。

## 关键可复用技术点（techniques）
- context 重叠泄露地址
- segmented spray 做落点定位
- pipe buffer 承载 fake port

## 与缓解机制的关系（notes）
- in-the-wild 复盘，细节以引用文章为准。

## 参考
- [writeup](https://projectzero.google/2019/08/in-wild-ios-exploit-chain-2.html)

### 参考内容摘要

**原文概述**：Project Zero 对野外发现的第二条链（Chain 2）深入解析，针对 iOS 10.3-10.3.3。漏洞是 IOSurface 相关的 Mach 端口引用计数错误（CVE-2017-13861），Ian Beer 在 2016 年底已向 Apple 报告并在 iOS 11.2 修复。攻击者利用手法更为成熟：继续使用多阶段堆喷（heap groom）策略——分配大量端口分组（ports_3/4/5/6），配合 target_port 占位形成可控 zone chunk；触发漏洞使 target_port 引用异常，mach_zone_force_gc 后执行"zone transfer"，用 kalloc.4096 的 OOL ports/memory 替换原 ipc.ports 区域；通过 mach_port_get_context 泄露地址，并结合 segmented spray 技术反复尝试直到成功定位 target_port；用 pipe buffers 承载完全可控的 fake port 结构，并使用经典的 clock_sleep_trap 在 256 种 KASLR 可能性中爆破得到正确 kernel_base；随后用 pid_for_task 建立 kread32 原语，再构造 fake kernel task port 绕过 iOS 10.3 新增的 kernel_task 检查（通过复制 kernel_task 结构到新地址欺骗指针比较）；最终与 Chain 1 相同的后利用：unsandbox（launchd ucred）、补丁平台策略字节码、trust cache 注入、spawn implant。新增的痕迹标记为在 bootargs 中写入"iopl"字符串。该链对 Zone GC、OOL descriptors、pipe buffer、clock_sleep/pid_for_task 等技巧综合运用，堪称教科书级别内核 exploit 范例。
