# mach_portal

- 目标系统: iOS 10.1.1
- CVE: CVE-2016-7644

## 初始原语（primitive）
通过竞争条件导致 Mach port 被 over-release，进而制造悬挂 port（dangling ipc_port）。

## 漏洞特定利用策略（strategy）
喷射大量 Mach ports 并在 set_dp_control_port() 上 race；释放后形成一页范围的 dangling ports。

## 后续通用利用流程（subsequent exploit flow）
触发 zone GC 让页被 OOL ports array 复用；用 mach_port_get_context 泄露 host port 地址并猜测 kernel task port 页；设置 context 为候选 ipc_port 地址并接收 OOL ports，得到 kernel task port send right。

## 关键可复用技术点（techniques）
- dangling Mach port 作为把手
- zone GC + OOL ports spray 复用内存
- mach_port_get_context 作为泄露/探测

## 与缓解机制的关系（notes）
- iOS 10 时代可触发 mach_zone_force_gc()，后续版本该条件变化。

## 参考
- [mach_portal exploit code](https://bugs.chromium.org/p/project-zero/issues/detail?id=965#c2)

### 参考内容摘要

**原文概述**：mach_portal 是 Ian Beer 对 iOS 10.1.1 上 CVE-2016-7644（Mach port race condition）的最早公开 exploit。核心漏洞在 set_dp_control_port() 中：竞争导致 port 被 over-release（引用计数低于实际持有者数）。攻击者创建大量 receive right ports，在 mach_port_insert_right 上发起竞争，使指定 port 的引用异常减少；通过 mach_zone_force_gc 将包含该 port 的 zone page 释放并变成可复用；用 OOL ports descriptors 喷射，重新分配为数组；通过 mach_port_get_context 逐一探测每个位置，判断哪些地址看起来像有效的 ipc_port（有已知特征）；构造 host port 作为锚点推测 kernel_task port 所在页面范围；设置 fake port 的 context 为候选页地址并接收 OOL ports 消息，若收到有效消息则获得该位置的 send right；反复尝试直到获得指向 kernel_task 的 port。这个 exploit 展示了早期 iOS 10 上 zone GC 仍可触发、OOL ports 堆喷的有效性、context 字段作为探测工具的妙用。后续 iOS 版本禁用 mach_zone_force_gc 后，这条链不再直接适用，但其思想对后续多个 exploit 有启发。
