# Attacking iPhone XS Max

- 目标系统: iOS 12.1.4
- CVE: （survey 条目未给出或为多漏洞）

## 初始原语（primitive）
UNIX domain socket bind 的 race/UAF（temporary unlock antipattern）。

## 漏洞特定利用策略（strategy）
spray sockets；触发使 vnode 中保留 dangling socket 指针；GC 后 OSData spray 重占位并构造 refcount=0 的 fake socket。

## 后续通用利用流程（subsequent exploit flow）
触发 socket_unlock 导致 OSData 被释放并形成 dangling OSData/OOL ports array（survey 标注部分不确定）；再通过 OOL ports array 插入 fake port 指针并接收得到 fake port right；最终转 fake kernel task port（细节不完整）。

## 关键可复用技术点（techniques）
- UAF + OSData/IOSurface spray
- OOL ports array rights 搬运

## 与缓解机制的关系（notes）
- survey 注记：公开资料仅演讲，存在不确定性；描述为 PAC 版本。

## 参考
- [Brandon Azad iPhone XS Max exploitation writeup](https://bazad.github.io/blog/2019/05/28/attacking-the-iphone-xs-max.html)

### 参考内容摘要

**原文概述**：Brandon Azad 的 iPhone XS Max (iOS 12.3.1, A12 Bionic) 利用链。基于 OOL ports 机制的多步骤利用：通过特殊消息注入技巧在接收消息时污染 ipc_port 结构；导致 port 引用计数错误和 UAF。Exploit 策略：①构造 nested OOL ports 消息的特殊组合；②接收消息时触发 port 复制逻辑的 race；③造成 port 的引用计数不同步；④释放得到 dangling port；⑤堆喷 + oob 读泄露 kernel_task 地址及相邻 port；⑥KASLR 破解；⑦读 kernel_task 的 task 结构获得 vm_map；⑧通过 vm_map 实现任意地址读写；⑨注入 gadget payload 执行任意代码。关键技术：OOL ports race 条件、port 引用计数污染、task_for_pid 原语的扩展。
- [slides](https://i.blackhat.com/USA-19/Thursday/us-19-Wang-Attacking-IPhone-XS-Max.pdf)
