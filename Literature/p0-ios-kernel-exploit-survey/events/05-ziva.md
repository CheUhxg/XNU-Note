# ziVA

- 目标系统: iOS 10.3.1
- CVE: （survey 条目未给出或为多漏洞）

## 初始原语（primitive）
AppleAVE2 多漏洞组合，泄露地址并触发受控虚调用。

## 漏洞特定利用策略（strategy）
泄露 IOSurface 地址与 IOFence vtable 破 KASLR；IOSurface property spray 重分配为可控对象；外部方法信任 userspace 指针导致虚调用劫持。

## 后续通用利用流程（subsequent exploit flow）
用 OSSerializer::serialize gadget 调用 copyin 覆写 sysctl_oid；组合 sysctl 读得到 3 参数任意调用；用 copyin/copyout 实现任意读写。

## 关键可复用技术点（techniques）
- vtable 泄露破 KASLR
- gadget 构造任意调用
- sysctl 作为触发入口

## 与缓解机制的关系（notes）
- iOS 10.3 引入 task_conversion_eval 初形态，之后多需 fake kernel task port。

## 参考
- [BlackHat slides](https://www.blackhat.com/docs/eu-17/materials/eu-17-Donenfeld-Rooten-Apples-Vulnerability-Heaven-In-The-IOS-Sandbox.pdf)
- [exploit code](https://github.com/doadam/ziVA)

### 参考内容摘要

**原文概述**：ziVA（zeroday in Vulnerability Assessment）是针对 iOS 10.3.1 AppleAVE2 视频编码驱动的多漏洞组合 exploit（由 Adam Donenfeld 等在 2017 BlackHat EU 演讲）。核心漏洞组合：①info leak（泄露 IOSurface 对象和 IOFence vtable 指针）破 KASLR；②IOSurface property 作为 heap groom 工具（反复序列化不同大小的 OSData 重分配）；③ExternalMethod 接口不验证参数指针（信任 userspace 指针指向有效对象），导致虚函数调用被劫持。Exploit 流程：①通过 ExternalMethod 调用触发虚调用到 OSSerializer::serialize，后者能遍历对象序列化为字典；②利用 serialize gadget 调用 copyin 覆写 sysctl 结构（sysctl_oid）；③通过 sysctl_name2oid + sysctl 系列调用实现 3 参数任意调用（不受限于 trap 的 7 参数）；④通过 copyin/copyout 建立任意读写基础；⑤构造 fake kernel task port。技术亮点包括：vtable 泄露破 KASLR、OSSerializer gadget 链、sysctl 作为任意调用入口。该漏洞链展示了 Apple 驱动开发中信任边界划分的脆弱性（直接信任 userspace 指针）。iOS 10.3+ 开始引入 task_conversion_eval 检查，试图限制从 userspace 创建的 port，但在这个 exploit 链中并未有效阻止（直接通过内核 gadget 构造）。
