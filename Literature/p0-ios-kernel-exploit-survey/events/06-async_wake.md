# async_wake

- 目标系统: iOS 11.1.2
- CVE: CVE-2017-13861 + CVE-2017-13865

## 初始原语（primitive）
信息泄露定位 port 地址 + 引用错误制造 dangling port。

## 漏洞特定利用策略（strategy）
用泄露找到任意 ports 地址；选择目标 port 触发 bug 释放，得到已知地址 dangling receive right。

## 后续通用利用流程（subsequent exploit flow）
强制 zone GC，让页被 ipc_kmsg 复用形成可控 fake port；转 fake task port 用 pid_for_task 建读原语（地址可通过 mach_port_set_context 更新）；定位对象并构造 fake kernel task port。

## 关键可复用技术点（techniques）
- 信息泄露 + 定点 dangling port
- pid_for_task 读原语（可更新地址）

## 与缓解机制的关系（notes）
- survey 注记：iOS 11 移除 mach_zone_force_gc，后续需新 GC 触发技术。

## 参考
- [exploit code](https://bugs.chromium.org/p/project-zero/issues/detail?id=1417#c17)

### 参考内容摘要

**原文概述**：async_wake（Ian Beer 针对 iOS 11.1.2 的 CVE-2017-13861 + CVE-2017-13865 组合 exploit）。漏洞同 v0rtex 但利用策略略有不同。关键区别在于信息泄露方式：①通过 IOConnectCallAsyncStructMethod 在不阻塞的情况下启动异步操作；②用 memory mapping 将 IOSurface 映射，直接在用户空间修改 shared buffer；③信息泄露用于定位任意 port 在内存中的位置；④触发 bug drop ref 使已知地址的 port 成为 dangling receive right；⑤强制 zone GC，让该 page 被 ipc_kmsg 重分配；⑥直接接收消息，因 ipc_kmsg 被控制，可从中伪造 fake port；⑦转 fake task port，pid_for_task 读 4 字节（通过 mach_port_set_context 更新地址）；⑧构造 fake kernel task port。技术细节：②IOConnectCallAsyncStructMethod 提供了异步触发的机制，避免某些同步 race；③地址泄露的方式更直接（内存映射而非通过 context/notification 字段）。该链展示了在 iOS 11 禁用 mach_zone_force_gc 后，仍可通过大量内存分配手动触发 GC 的变通手法。后续 iOS 版本对 GC 和 zone allocator 结构多次调整，进一步加强了反利用。
