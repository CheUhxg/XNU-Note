# Kernel Stack Canaries（iOS 6）

## 机制是什么
内核栈 canary（stack cookie）用于检测**栈缓冲区溢出**导致的返回地址/栈帧篡改，典型做法是在栈上放置随机值并在函数返回前校验。

## 对利用链的影响（按 survey 的结论）
- survey 指出：其列举的 iOS 10–13 公开内核利用大多不是“栈溢出”，因此**基本不受该机制直接影响**。

## 学习要点
- 能区分：栈溢出 vs 堆溢出 vs UAF vs 引用计数/MIG 语义类 bug。
- 看到 exploit flow 里主要是 heap grooming / fake objects 时，通常与栈 canary 无关。

## 参考内容摘要

**核心机制**：Kernel Stack Canaries（iOS 12+）在内核函数栈帧中插入随机值（canary），函数返回前验证值未被修改。任何栈缓冲区溢出导致 canary 改变都会触发 panic。Apple 使用 per-boot 和 per-function 的随机化策略，增加绕过难度。

**对现代利用的影响**：Kernel Stack Canaries 直接防御了栈缓冲区溢出到控制流劫持的经典路线。然而，由于 iOS kernel 中栈溢出相对少见（多数缓冲区分配在堆上），该缓解的实际防御范围有限。部分驱动或特定代码路径（例如 audio driver 的缓冲处理）可能涉及栈操作，但公开 exploit 中栈溢出链条稀少。

**绕过现状**：在有堆溢出、UAF、OOB 写能力的前提下，canary 保护的栈几乎不是主要目标（攻击者优先利用堆写原语）。某些链若包含栈溢出，通常会先完成其他阶段（如 KASLR 破解），再通过特权执行绕过或逃逸 panic。

**缓解评估**：Kernel Stack Canaries 是良好的进程级防御，但 iOS kernel exploit 主要依赖堆级漏洞，使其防御效果相对被动。

## 参考
- Survey：iOS kernel exploit mitigations / Kernel Stack Canaries
- Survey：iOS kernel exploit mitigations / Kernel Stack Canaries
