# Kernel Heap ASLR（iOS 6）

## 机制是什么
内核堆相关区域基址随机化，降低“把对象稳定放在某个硬编码地址”的可行性。

## 对利用链的影响
- survey 指出：现代利用通常通过 **heap spray / grooming** 来“塑形”，即使不知道精确地址也能影响布局。
- 另一路线是先拿到**信息泄露**，得到关键对象地址后再做精准操作。

## 典型工程化对策
- spray：IOSurface properties / OOL memory / OOL ports / pipe buffers 等载体
- reclaim：制造 hole、触发回收/GC、让目标类型重新占位

## 参考内容摘要

**核心机制**：Kernel Heap ASLR（iOS 11+）随机化内核堆分配器（kalloc zones）中对象的分配顺序和位置。与文本 KASLR 相同的思路，但针对堆对象。由于内核堆管理相对简化（无 malloc hook），randomization 主要通过zone 初始化顺序、freelist 重排等实现。部分 zone 的分配可能进一步使用内核 entropy 进行地址混淆。

**对现代利用的影响**：Kernel Heap ASLR 禁止了"堆喷 + 已知地址覆写"的直接套路。早期链（yalu102）在固定堆地址假设下构造虚假结构，iOS 11+ 后需要配合泄露步骤（OOB 读、UAF 等）定位对象。多数现代 chain 通过"区域喷射（zone allocation）+ 泄露定位"的组合来应对，而非依赖固定堆地址。

**绕过现状**：大多数 exploit 通过以下方式工作：①喷射已知内容的对象（如 ipc_kmsg、OSString），②用 UAF/OOB 泄露其地址，③根据泄露的对象地址推导同 zone 内相邻对象的布局。这个过程比固定地址复杂，但仍然可行。

**缓解评估**：Kernel Heap ASLR 有效阻止了基于固定堆地址的简单 exploit，提升了 exploit 复杂度和不稳定性，但与 kernel text ASLR 类似，主要依赖泄露的困难程度。

## 参考
- Survey：iOS kernel exploit mitigations / Kernel Heap ASLR
- Survey：iOS kernel exploit mitigations / Kernel Heap ASLR
