# zone_require（iOS 13）

## 机制是什么
zone_require 是 iOS 13 引入的软件缓解：在使用某些关键对象指针前，检查该指针是否来自预期的 zalloc zone。

## 对利用链的影响（survey 的归纳）
- 对 iOS kernel exploit 影响很大的一点是：Mach port 等对象会被频繁检查（例如 lock `ipc_port` 时检查其是否来自 `ipc.ports` zone）。
- 这会直接打击“把 fake Mach port 伪造在 OSData/kalloc 缓冲里”的常见套路。
- survey 提到曾有公开绕过，但依赖实现疏漏，且容易修补。

## 参考内容摘要

**核心机制**：Zone Require（iOS 14+）在内核堆管理器中启用 metadata hardening 和 zone pointer 验证。在对象释放或重分配时，验证对象的 zone 标记和 metadata 完整性。任何试图将对象放入错误 zone 的操作都会被拒绝。Requires 也包括对跨 zone 对象指针的验证，防止利用 zone 类型混淆实现的 exploit。

**对现代利用的影响**：Zone Require 直接打击了依赖 zone 混淆和交叉污染的 exploit 策略。例如早期链通过"在 kalloc.16 释放一个对象，再在 ipc.ports zone 分配相同大小对象，产生重叠覆写"的套路，在 Zone Require 下会被检测和拒绝。这强制 exploit 要么在同一 zone 内进行（更受限），要么采用更复杂的堆喷策略（例如跨多个较小 zone 的精细控制）。

**绕过现状**：Zone Require 作为 iOS 14+ 的新防御，绕过方法仍在探索。已知方向包括：①利用 zone 分配边界（zone transition 时刻的竞态），②发现 zone 验证的漏洞（例如特定 code path 跳过检查），③利用未受保护的旧 zone（某些驱动可能使用较老的分配器）。

**缓解评估**：Zone Require 代表内核堆保护的新阶段，与 Heap ASLR、CFI 等协作，显著提升了堆污染 exploit 的难度，但与 KTRR 不同，硬件实现有限，存在软件层绕过空间。

## 参考
- Survey：iOS kernel exploit mitigations / Zone Require
- Survey：iOS kernel exploit mitigations / zone_require
