# KTRR / KIP v1（iOS 10，对应 A10）

## 机制是什么
KTRR（常被理解为 Kernel Text Readonly Region）是 Apple 在 A10 引入的硬件级保护，覆盖 kernelcache 中只读部分及一些敏感结构（如顶层页表、trust cache 等），强化 W^X，使其更难被软件层面绕过。

## 对利用链的影响（survey 的归纳）
- 现代公开 exploit 往往采取“绕开 KTRR 保护区”的策略：
  - 不去修改 KTRR 保护的内存
  - 更多通过修改非保护区的数据结构达成目标

## 参考内容摘要

**核心机制**：KTRR（Kernel Translation Reclaim Register，iOS 10+）和 KIP（Kernel Integrity Protection）基于 ARM TTBR hardening。KTRR 在 CPU 硬件层级禁止某些内存区域的 TLB 条目被 EL1（kernel）修改，即使 kernel 尝试改写页表也会被 CPU 拒绝。KIP 是苹果的软件层增强，进一步标记哪些页表区域和代码段需要 KTRR 保护。

**对现代利用的影响**：KTRR 直接禁止了"修改页表映射以改变内核代码权限"的路线（例如把 RX 页改为 RW）。即使获得内核读写能力，也无法通过页表修改来实现持久代码执行。这大幅提升了从临时代码执行（如 JOP gadget）到持久修改的难度。早期链（yalu102、async_wake）在 A10+ 遇到 KTRR 限制，转向了依赖单次漏洞加载代码或借助 sandbox 逃逸的策略。

**绕过现状**：KTRR 在硬件层实现，完整绕过极其困难。大多数 exploit 的应对是避免修改内核映射，改用 PPL/SPRR 等软件层漏洞。某些研究尝试在 TTBR 切换窗口插入竞态，但成功率有限。

**缓解评估**：KTRR 是内核代码完整性保护的重要支柱，对长期 persistence 防御有明显效果，但对临时执行权的限制有限。

## 参考
- Survey：iOS kernel exploit mitigations / KTRR-KIP
- Survey：iOS kernel exploit mitigations / KTRR
